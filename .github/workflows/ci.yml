name: CI

on:
  push:
    branches: [ main, beta-2.0.0, develop ]
  pull_request:
    branches: [ main, beta-2.0.0, develop ]

jobs:
  lint:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–æ–≤
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
        continue-on-error: false
      
      - name: Check TypeScript types
        run: npm run typecheck
        continue-on-error: false
      
      - name: Check for common bugs
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏..."
          
          if grep -r "console\.log\|console\.error" src/ --include="*.ts" | grep -v "logger"; then
            echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã console.log/error –≤–º–µ—Å—Ç–æ logger"
            exit 1
          fi
          
          if grep -r "any" src/ --include="*.ts" | grep -v "node_modules" | wc -l | grep -q "^[1-9]"; then
            echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ 'any'"
          fi
          
          if grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.ts"; then
            echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã TODO/FIXME –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"
          fi
          
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        continue-on-error: true

  build:
    name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
        continue-on-error: false
      
      - name: Check build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå –ü–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            exit 1
          fi
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå –§–∞–π–ª dist/index.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ dist:"
            ls -la dist/ || echo "–ü–∞–ø–∫–∞ dist –ø—É—Å—Ç–∞"
            if [ -d "dist/src" ]; then
              echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ dist/src:"
              ls -la dist/src/ || echo "–ü–∞–ø–∫–∞ dist/src –ø—É—Å—Ç–∞"
            fi
            exit 1
          fi
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
          echo "üìÅ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: dist/index.js"

  test-commands:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run command tests
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TEST_USER_ID: ${{ secrets.TEST_USER_ID }}
        run: npm run test:commands
        continue-on-error: false

  health-check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run health check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TEST_USER_ID: ${{ secrets.TEST_USER_ID }}
        run: npm run test:health
        continue-on-error: false

  stress-test:
    name: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta-2.0.0')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run stress test
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TEST_USER_ID: ${{ secrets.TEST_USER_ID }}
        run: npm run test:stress
        continue-on-error: true

  summary:
    name: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    runs-on: ubuntu-latest
    needs: [lint, build, test-commands, health-check]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| –õ–∏–Ω—Ç—ã | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| –°–±–æ—Ä–∫–∞ | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| –¢–µ—Å—Ç—ã –∫–æ–º–∞–Ω–¥ | ${{ needs.test-commands.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ] || [ "${{ needs.test-commands.result }}" != "success" ] || [ "${{ needs.health-check.result }}" != "success" ]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
            exit 1
          fi
          
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

